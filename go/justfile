default:
    @just --list

# --- INSTALL & DEPS ---

deps: deps-shell deps-greeter

deps-shell:
    cd shell/frontend && yarn install
    cd shell/backend && go mod tidy && gomod2nix

deps-greeter:
    cd services/greeter/frontend && yarn install
    cd services/greeter/backend && go mod tidy && gomod2nix

# --- CODE GENERATION ---

gen:
    cd services/greeter/backend && protoc --go_out=. --go_opt=paths=source_relative \
           --go-grpc_out=. --go-grpc_opt=paths=source_relative \
           proto/helloworld/helloworld.proto

# --- RUNNING ---

run-shell:
    @echo "Building Shell Frontend..."
    cd shell/frontend && yarn build
    @echo "Starting Shell Host on :8080..."
    cd shell/backend && SERVER_STATIC_DIR=../frontend/dist HTTP_PORT=8080 go run main.go

run-greeter:
    @echo "Building Greeter Widget..."
    cd services/greeter/frontend && yarn build
    @echo "Starting Greeter Service on :8081 & :50051..."
    cd services/greeter/backend && SERVER_STATIC_DIR=../frontend/dist HTTP_PORT=8081 go run main.go

# --- BUILD & TEST ---

build:
    nix build .

grpc-test:
    grpcurl -plaintext -d '{"name": "JustUser"}' localhost:50051 helloworld.Greeter/SayHello
