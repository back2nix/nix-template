# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ .env
set dotenv-load
# –í–ê–ñ–ù–û: –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –≤—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ –¥–æ—á–µ—Ä–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã (envsubst, go run –∏ —Ç.–¥.)
# –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –∏–∑–±–µ–∂–∞—Ç—å –¥–ª–∏–Ω–Ω—ã—Ö export VAR=... –≤ —Ä–µ—Ü–µ–ø—Ç–∞—Ö
set export := true

default:
    @just --list

# –°–ø–∏—Å–æ–∫ —Å–µ—Ä–≤–∏—Å–æ–≤
SERVICES := "shell landing chat notification"
ALL_IMAGES := "gateway shell landing chat notification"

# ===========================================
# INSTALL & DEPS
# ===========================================

link-pkg:
    @echo "üîó Linking shared 'pkg' to backends..."
    @for service in {{SERVICES}}; do \
        mkdir -p services/$service/backend/pkg; \
        cd services/$service/backend && rm -rf pkg && ln -sf ../../../pkg pkg && cd - > /dev/null; \
    done

deps: link-pkg
    @echo "üì¶ Installing dependencies for all services..."
    @for service in {{SERVICES}}; do \
        echo "üîπ Service: $service"; \
        if [ -d "services/$service/frontend" ]; then \
            echo "   [Frontend] Yarn install..."; \
            cd services/$service/frontend && yarn install --silent && cd - > /dev/null; \
        fi; \
        echo "   [Backend] Go tidy & gomod2nix..."; \
        cd services/$service/backend && go mod tidy; \
            gomod2nix; \
        cd - > /dev/null; \
        cd services/$service/backend && go mod tidy && cd - > /dev/null; \
    done

# ===========================================
# CODE QUALITY
# ===========================================

fmt service="all":
    @if [ "{{service}}" = "all" ]; then \
        for s in {{SERVICES}}; do just fmt $s; done; \
    else \
        echo "üé® Formatting {{service}}..."; \
        cd services/{{service}}/backend && go fmt ./...; \
    fi

lint service="all":
    @if [ "{{service}}" = "all" ]; then \
        for s in {{SERVICES}}; do just lint $s; done; \
    else \
        echo "üîç Linting {{service}}..."; \
        cd services/{{service}}/backend && golangci-lint run ./... -v --config ../../../.golangci.yml; \
    fi

lint-fix service="all":
    @if [ "{{service}}" = "all" ]; then \
        for s in {{SERVICES}}; do just lint-fix $s; done; \
    else \
        echo "üîß Fixing Lint errors in {{service}}..."; \
        cd services/{{service}}/backend && golangci-lint run --fix ./... --config ../../../.golangci.yml; \
    fi

vuln service="all":
    @if [ "{{service}}" = "all" ]; then \
        for s in {{SERVICES}}; do just vuln $s; done; \
    else \
        echo "üõ°Ô∏è  Checking vulnerabilities in {{service}}..."; \
        cd services/$service/backend && govulncheck ./...; \
    fi

fieldalignment service="all":
    @if [ "{{service}}" = "all" ]; then \
        for s in {{SERVICES}}; do just fieldalignment $s; done; \
    else \
        echo "üìê Aligning fields in {{service}}..."; \
        cd services/{{service}}/backend && \
        go run golang.org/x/tools/go/analysis/passes/fieldalignment/cmd/fieldalignment@latest -test=false -fix ./...; \
    fi

check-all: fmt lint vuln

# ===========================================
# CODE GENERATION
# ===========================================

gen-proto: gen-proto-notification

gen-proto-notification:
    @echo "üî® Generating Notification Proto..."
    protoc --go_out=. --go_opt=paths=source_relative \
        --go-grpc_out=. --go-grpc_opt=paths=source_relative \
        pkg/proto/notification/notification.proto

# ===========================================
# RUNNING (Development)
# ===========================================

dev-all:
    #!/usr/bin/env bash
    set -e
    echo "üöÄ Starting all services..."
    just kill-ports

    echo "Starting Gateway..."
    just dev-gateway &
    sleep 2

    echo "Starting Services..."
    just dev-shell &
    just dev-landing &
    just dev-chat &
    just dev-notification &

    echo ""
    echo "‚è≥ Waiting 5 seconds for startup..."
    sleep 5
    just check-status

dev-gateway:
    @echo "üåê Starting Envoy Gateway on :${GATEWAY_HTTP_PORT}..."
    @envsubst < services/gateway/envoy.tmpl.yaml > /tmp/envoy.yaml && \
    envoy -c /tmp/envoy.yaml --service-cluster gateway --service-node dev > /tmp/gateway.log 2>&1

dev-shell:
    @echo "üñ•  Starting Shell (Host)..."
    cd services/shell/frontend && \
    VITE_OTEL_ENDPOINT="${VITE_OTEL_ENDPOINT}" \
    VITE_GATEWAY_URL="${VITE_GATEWAY_URL}" \
    VITE_LANDING_REMOTE_URL="${VITE_GATEWAY_URL}/api/landing/remoteEntry.js" \
    VITE_CHAT_REMOTE_URL="${VITE_GATEWAY_URL}/api/chat/remoteEntry.js" \
    yarn build
    cd services/shell/backend && go run cmd/server/main.go > /tmp/shell.log 2>&1

dev-landing:
    @echo "üõ¨ Starting Landing Service..."
    cd services/landing/frontend && \
    VITE_BASE_PATH=/api/landing/ \
    VITE_GATEWAY_URL="${VITE_GATEWAY_URL}" \
    VITE_OTEL_ENDPOINT="${VITE_OTEL_ENDPOINT}" \
    yarn build
    cd services/landing/backend && go run cmd/server/main.go > /tmp/landing.log 2>&1

dev-chat:
    @echo "üí¨ Starting Chat Service..."
    cd services/chat/frontend && \
    VITE_BASE_PATH=/api/chat/ \
    VITE_GATEWAY_URL="${VITE_GATEWAY_URL}" \
    VITE_OTEL_ENDPOINT="${VITE_OTEL_ENDPOINT}" \
    yarn build
    cd services/chat/backend && go run cmd/server/main.go > /tmp/chat.log 2>&1

dev-notification:
    @echo "üîî Starting Notification Service..."
    cd services/notification/backend && go run cmd/server/main.go > /tmp/notification.log 2>&1

# ===========================================
# KUBERNETES / K3S OPERATIONS
# ===========================================

# –°—Ç—Ä–æ–∏—Ç –∏ –∑–∞–≥—Ä—É–∂–∞–µ—Ç –¢–û–õ–¨–ö–û –±–∞–∑–æ–≤—ã–π –æ–±—Ä–∞–∑ (–Ω—É–∂–Ω–æ –æ–¥–∏–Ω —Ä–∞–∑)
k3s-load-base:
    @echo "üèó  Building Base Image..."
    nix build .#dockerImages.devBase -o result-dev-base
    @echo "üöö Loading Base Image to K3s..."
    sudo k3s ctr images rm docker.io/library/dev-base:latest > /dev/null 2>&1 || true
    sudo k3s ctr images import ./result-dev-base
    @rm result-dev-base
    @echo "‚úÖ Base image ready."

# üöÄ MAGICAL HACK: –ë—ã—Å—Ç—Ä—ã–π –¥–µ–ø–ª–æ–π –±–µ–∑ —Å–±–æ—Ä–∫–∏ Docker
k3s-fast-deploy: k3s-fix-config k3s-check
    #!/usr/bin/env bash
    set -e
    echo "‚ö° STARTING FAST DEPLOYMENT (Nix Store Mount Mode)"

    # 0. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –±–∞–∑–æ–≤–æ–≥–æ –æ–±—Ä–∞–∑–∞
    if ! sudo k3s ctr images ls | grep -q "dev-base"; then
        echo "‚ö†Ô∏è Base image not found. Building and loading first..."
        just k3s-load-base
    fi

    # 1. –°–±–æ—Ä–∫–∞ –±–∏–Ω–∞—Ä–Ω–∏–∫–æ–≤ –∏ –ø–æ–ª—É—á–µ–Ω–∏–µ –ü–†–Ø–ú–´–• –ø—É—Ç–µ–π –∫ Store
    echo "üèó  Building service binaries in parallel..."

    BUILD_OUTPUT=$(nix build \
        .#k8s.gateway \
        .#k8s.shell \
        .#k8s.landing \
        .#k8s.chat \
        .#k8s.notification \
        --print-out-paths \
        --no-link)

    export GATEWAY_BIN=$(echo "$BUILD_OUTPUT" | grep gateway)
    export SHELL_BIN=$(echo "$BUILD_OUTPUT" | grep shell)
    export LANDING_BIN=$(echo "$BUILD_OUTPUT" | grep landing)
    export CHAT_BIN=$(echo "$BUILD_OUTPUT" | grep chat)
    export NOTIFICATION_BIN=$(echo "$BUILD_OUTPUT" | grep notification)

    echo "üìç Direct Store Paths:"
    echo "   Gateway: $GATEWAY_BIN"
    echo "   Shell:   $SHELL_BIN"
    echo "   Landing: $LANDING_BIN"
    echo "   Chat:    $CHAT_BIN"
    echo "   Notif:   $NOTIFICATION_BIN"

    # 2. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞ —Å –∑–∞–º–µ–Ω–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
    echo "üìÑ Applying K8s manifests..."
    export KUBECONFIG=~/.kube/config

    # –ü—Ä–∏–º–µ–Ω—è–µ–º –±–∞–∑–æ–≤—ã–µ –∫–æ–Ω—Ñ–∏–≥–∏ (Observability, Logs)
    kubectl apply -f deployments/k8s/observability.yaml --validate=false
    kubectl apply -f deployments/k8s/fluent-bit.yaml --validate=false

    # --- FIX: –ü—Ä–∏–º–µ–Ω—è–µ–º –¥–∞—à–±–æ—Ä–¥—ã ---
    kubectl apply -f deployments/k8s/dashboards.yaml --validate=false

    # --- NEW: –ü—Ä–∏–º–µ–Ω—è–µ–º Storage (ScyllaDB) ---
    kubectl apply -f deployments/k8s/storage.yaml --validate=false

    # --- NEW: –ü—Ä–∏–º–µ–Ω—è–µ–º Queue (Redpanda) ---
    kubectl apply -f deployments/k8s/queue.yaml --validate=false

    # --- FIX: –Ø–≤–Ω–æ —Å–æ–∑–¥–∞–µ–º namespace 'app' –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π –∫–æ–Ω—Ñ–∏–≥–æ–≤ ---
    kubectl create namespace app --dry-run=client -o yaml | kubectl apply -f -

    # –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –ø—Ä–∏–º–µ–Ω—è—Ç—å –∫–æ–Ω—Ñ–∏–≥–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    kubectl apply -f deployments/k8s/runtime-config.yaml --validate=false

    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∏ –ø—Ä–∏–º–µ–Ω—è–µ–º –º–∞–Ω–∏—Ñ–µ—Å—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π (Service, Deployment)
    envsubst < deployments/k8s/apps-dev.tmpl.yaml | kubectl apply -f -

    # 3. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø–æ–¥–æ–≤
    echo "üîÑ Restarting deployments to pick up new paths..."
    kubectl rollout restart deployment gateway shell landing chat notification -n app

    echo "‚úÖ Fast deploy complete! Pods are restarting..."
    kubectl get pods -n app

build-images:
    #!/usr/bin/env bash
    set -e
    SERVICES="{{ALL_IMAGES}}"

    # –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –∏—Ç–æ–≥–æ–≤
    TOTAL_APP_TIME=0
    TOTAL_DOCKER_TIME=0
    TOTAL_ARCHIVE_SIZE=0

    echo ""
    echo "üèó  DETAILED BUILD REPORT"
    echo "======================================================================================================="
    printf "%-15s | %-12s | %-12s | %-12s | %-12s | %-12s\n" "SERVICE" "APP TIME" "APP SIZE" "DOCKER TIME" "FILE SIZE" "TOTAL TIME"
    echo "-------------------------------------------------------------------------------------------------------"

    for service in $SERVICES; do
        # 1. –°–ë–û–†–ö–ê –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø (Binary)
        # –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è, —á—Ç–æ –≤ flake.nix —É –≤–∞—Å –µ—Å—Ç—å package —Å –∏–º–µ–Ω–µ–º —Å–µ—Ä–≤–∏—Å–∞
        rm -f result-bin-$service

        START_APP=$(date +%s)
        # –°—Ç—Ä–æ–∏–º —Ç–æ–ª—å–∫–æ –±–∏–Ω–∞—Ä–Ω–∏–∫/–ø–∞–∫–µ—Ç
        nix build .#$service -o result-bin-$service > /dev/null 2>&1
        END_APP=$(date +%s)

        APP_DURATION=$((END_APP - START_APP))
        # du -L —Å–ª–µ–¥—É–µ—Ç –ø–æ —Å—Å—ã–ª–∫–µ –≤ /nix/store
        APP_SIZE_HUMAN=$(du -Lsh result-bin-$service | awk '{print $1}')

        # 2. –°–ë–û–†–ö–ê –î–û–ö–ï–†-–ê–†–•–ò–í–ê
        rm -f result-$service

        START_DOCKER=$(date +%s)
        # –°—Ç—Ä–æ–∏–º –æ–±—Ä–∞–∑
        nix build .#dockerImages.$service -o result-$service > /dev/null 2>&1
        END_DOCKER=$(date +%s)

        DOCKER_DURATION=$((END_DOCKER - START_DOCKER))
        # –†–∞–∑–º–µ—Ä –∞—Ä—Ö–∏–≤–∞ tar.gz
        DOCKER_SIZE_HUMAN=$(du -Lsh result-$service | awk '{print $1}')
        # –†–∞–∑–º–µ—Ä –≤ –±–∞–π—Ç–∞—Ö –¥–ª—è –ø–æ–¥—Å—á–µ—Ç–∞ —Å—É–º–º—ã
        DOCKER_SIZE_BYTES=$(du -Lb result-$service | awk '{print $1}')

        TOTAL_DURATION=$((TOTAL_DURATION + APP_DURATION + DOCKER_DURATION))

        printf "%-15s | %-12s | %-12s | %-12s | %-12s | %-12s\n" \
            "$service" "${APP_DURATION}s" "$APP_SIZE_HUMAN" "${DOCKER_DURATION}s" "$DOCKER_SIZE_HUMAN" "${TOTAL_DURATION}s"

        # –°—É–º–º–∏—Ä—É–µ–º
        TOTAL_APP_TIME=$((TOTAL_APP_TIME + APP_DURATION))
        TOTAL_DOCKER_TIME=$((TOTAL_DOCKER_TIME + DOCKER_DURATION))
        TOTAL_ARCHIVE_SIZE=$((TOTAL_ARCHIVE_SIZE + DOCKER_SIZE_BYTES))

        # –ß–∏—Å—Ç–∏–º —Å–∏–º–ª–∏–Ω–∫ –Ω–∞ –±–∏–Ω–∞—Ä–Ω–∏–∫
        rm -f result-bin-$service
    done

    # –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –±–∞–π—Ç –≤ —á–∏—Ç–∞–µ–º—ã–π –≤–∏–¥
    TOTAL_SIZE_HUMAN=$(numfmt --to=iec-i --suffix=B $TOTAL_ARCHIVE_SIZE 2>/dev/null || echo "$TOTAL_ARCHIVE_SIZE bytes")
    TOTAL_ALL_TIME=$((TOTAL_APP_TIME + TOTAL_DOCKER_TIME))

    echo "-------------------------------------------------------------------------------------------------------"
    printf "%-15s | %-12s | %-12s | %-12s | %-12s | %-12s\n" \
        "TOTAL" "${TOTAL_APP_TIME}s" "-" "${TOTAL_DOCKER_TIME}s" "$TOTAL_SIZE_HUMAN" "${TOTAL_ALL_TIME}s"
    echo "======================================================================================================="
    echo "‚úÖ Images built (check result-* symlinks)"

load-images: build-images
    #!/usr/bin/env bash
    set -e
    SERVICES="{{ALL_IMAGES}}"

    TOTAL_LOAD_TIME=0

    echo ""
    echo "üöö LOAD REPORT (Import to K3s)"
    echo "=========================================================================="
    printf "%-15s | %-10s | %-15s\n" "SERVICE" "LOAD TIME" "IMAGE SIZE (K3s)"
    echo "--------------------------------------------------------------------------"

    # –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –æ–±—Ä–∞–∑–æ–≤
    for service in $SERVICES; do
        sudo k3s ctr images rm docker.io/library/$service:latest > /dev/null 2>&1 || true
    done

    for service in $SERVICES; do
        # –ó–∞–º–µ—Ä –≤—Ä–µ–º–µ–Ω–∏ –∑–∞–≥—Ä—É–∑–∫–∏
        START_TIME=$(date +%s)

        sudo k3s ctr images import ./result-$service > /dev/null

        END_TIME=$(date +%s)
        DURATION=$((END_TIME - START_TIME))

        # –ü–æ–ª—É—á–∞–µ–º —Ä–∞–∑–º–µ—Ä –æ–±—Ä–∞–∑–∞ –≤–Ω—É—Ç—Ä–∏ K3s
        IMG_SIZE=$(sudo k3s ctr images ls | grep "library/$service:latest" | awk '{print $(NF-1)}')

        printf "%-15s | %-9s | %-15s\n" "$service" "${DURATION}s" "$IMG_SIZE"

        TOTAL_LOAD_TIME=$((TOTAL_LOAD_TIME + DURATION))
    done

    echo "--------------------------------------------------------------------------"
    printf "%-15s | %-9s | %-15s\n" "TOTAL" "${TOTAL_LOAD_TIME}s" "See above"
    echo "=========================================================================="
    echo "‚úÖ All images loaded into K3s containerd"

# –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞
reload-service service:
    @echo "üîÑ Reloading {{service}} in K3s..."
    @rm -f result-{{service}}
    nix build .#dockerImages.{{service}} -o result-{{service}}
    sudo k3s ctr images rm docker.io/library/{{service}}:latest 2>/dev/null || true
    sudo k3s ctr images import ./result-{{service}}
    kubectl delete pod -n app -l app={{service}}
    @echo "‚è≥ Waiting for pod to start..."
    @kubectl wait --for=condition=ready pod -l app={{service}} -n app --timeout=60s || true
    @echo "‚úÖ {{service}} reloaded"
    @kubectl logs -n app -l app={{service}} --tail=10

# --- FIX: –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –ª–µ—á–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥–∞ –∏ –∫—ç—à–∞ ---
k3s-fix-config:
    @echo "üöë Fixing Kubeconfig & Cleaning Cache..."
    @rm -rf ~/.kube/cache ~/.kube/http-cache
    @mkdir -p ~/.kube
    @sudo cp /etc/rancher/k3s/k3s.yaml ~/.kube/config
    @sudo chown $(id -u):$(id -g) ~/.kube/config
    @chmod 600 ~/.kube/config
    @echo "‚úÖ Kubeconfig refreshed in ~/.kube/config"

k3s-check:
    @echo "üîç Checking K8s connection..."
    @export KUBECONFIG=~/.kube/config; kubectl get nodes > /dev/null || (echo "‚ùå Connection failed. Run 'just k3s-fix-config' first."; exit 1)
    @echo "‚úÖ K8s is reachable."

k3s-deploy: k3s-fix-config k3s-check
    @echo "üöÄ Deploying to K3s..."
    export KUBECONFIG=~/.kube/config; kubectl apply -f deployments/k8s/observability.yaml --validate=false
    export KUBECONFIG=~/.kube/config; kubectl apply -f deployments/k8s/dashboards.yaml --validate=false
    export KUBECONFIG=~/.kube/config; kubectl apply -f deployments/k8s/fluent-bit.yaml --validate=false
    # –î–æ–±–∞–≤–ª—è–µ–º –¥–µ–ø–ª–æ–π –æ—á–µ—Ä–µ–¥–∏ (Infra)
    export KUBECONFIG=~/.kube/config; kubectl apply -f deployments/k8s/queue.yaml --validate=false
    # –î–æ–±–∞–≤–ª—è–µ–º –¥–µ–ø–ª–æ–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (Storage)
    export KUBECONFIG=~/.kube/config; kubectl apply -f deployments/k8s/storage.yaml --validate=false
    # –î–µ–ø–ª–æ–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π
    export KUBECONFIG=~/.kube/config; kubectl apply -f deployments/k8s/apps.yaml --validate=false
    export KUBECONFIG=~/.kube/config; kubectl apply -f deployments/k8s/runtime-config.yaml --validate=false
    @echo "‚è≥ Waiting for pods to initialize..."
    @sleep 5
    export KUBECONFIG=~/.kube/config; kubectl get pods -A

k3s-up: load-images k3s-deploy
    @echo "üîÑ Restarting all application pods..."
    kubectl delete pod -n app --all
    @echo "‚è≥ Waiting for pods to restart..."
    @sleep 10
    @kubectl get pods -n app
    @echo ""
    @echo "üåü System is up in K3s!"
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –∏–∑ .env –¥–ª—è –≤—ã–≤–æ–¥–∞ IP/–ø–æ—Ä—Ç–∞ (–ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º localhost –¥–ª—è –ø—Ä–∏–º–µ—Ä–∞, –Ω–æ –ø–æ—Ä—Ç –≤–∞–∂–µ–Ω)
    @echo "Gateway: http://localhost:${GATEWAY_HTTP_PORT}"

k3s-observability:
  kubectl delete namespace observability
  kubectl apply -f deployments/k8s/observability.yaml
  kubectl apply -f deployments/k8s/fluent-bit.yaml

k3s-clean:
    @echo "üßπ Removing K8s resources..."
    export KUBECONFIG=~/.kube/config; kubectl delete namespace app queue storage observability --ignore-not-found
    rm -f result-*

k3s-logs SERVICE:
    @echo "üìã Logs for {{SERVICE}}..."
    @export KUBECONFIG=~/.kube/config; \
    POD=$(kubectl get pods -n app -l app={{SERVICE}} -o jsonpath='{.items[0].metadata.name}' 2>/dev/null); \
    if [ -z "$POD" ]; then \
        echo "‚ùå Pod for service '{{SERVICE}}' not found"; \
        echo "Available services:"; \
        kubectl get pods -n app --no-headers | awk '{print "  -", $1}' | sed 's/-[^-]*-[^-]*$//'; \
        exit 1; \
    fi; \
    kubectl logs -n app $POD -f

k3s-logs-all:
    @echo "üìã Watching logs from all services..."
    @export KUBECONFIG=~/.kube/config; \
    kubectl logs -n app -l 'app' --all-containers=true -f --prefix=true

k3s-redpanda:
  kubectl port-forward -n observability svc/redpanda-console 8090:8080

# ===========================================
# BUILD (Nix)
# ===========================================

build target="all":
    nix build .#{{target}}

# ===========================================
# UTILITIES
# ===========================================

check-status:
    #!/usr/bin/env bash
    echo ""
    echo "üìä SERVICE STATUS REPORT"
    echo "=============================================================="
    printf "%-15s | %-8s | %-15s | %-10s\n" "SERVICE" "PORT" "STATUS" "PID"
    echo "--------------------------------------------------------------"

    check_port() {
        local name=$1
        local port=$2
        local pid=$(lsof -ti:$port 2>/dev/null)
        if [ -n "$pid" ]; then
            printf "%-15s | %-8s | \033[32m‚úÖ UP\033[0m            | %-10s\n" "$name" "$port" "$pid"
        else
            printf "%-15s | %-8s | \033[31m‚ùå DOWN\033[0m          | %-10s\n" "$name" "$port" "-"
        fi
    }

    check_port "Gateway"      "${GATEWAY_HTTP_PORT}"
    check_port "Shell"        "${SHELL_SERVER_HTTP_PORT}"
    check_port "Landing"      "${LANDING_SERVER_HTTP_PORT}"
    check_port "Chat"         "${CHAT_SERVER_HTTP_PORT}"
    check_port "Notification" "${NOTIFICATION_SERVER_HTTP_PORT}"
    echo "=============================================================="
    echo "üìù Logs available in /tmp/*.log"
    echo ""

kill-ports:
    #!/usr/bin/env bash
    echo "üíÄ Checking ports to kill..."
    kill_if_exists() {
        local name=$1
        local port=$2
        local pid=$(lsof -ti:$port 2>/dev/null)
        if [ -n "$pid" ]; then
            kill -9 $pid 2>/dev/null
            echo -e "   üîª $name (:$port): \033[31mKilled PID $pid\033[0m"
        else
            echo -e "   ‚ö™ $name (:$port): \033[90mAlready free\033[0m"
        fi
    }
    kill_if_exists "Gateway"      "${GATEWAY_HTTP_PORT}"
    kill_if_exists "Shell"        "${SHELL_SERVER_HTTP_PORT}"
    kill_if_exists "Landing"      "${LANDING_SERVER_HTTP_PORT}"
    kill_if_exists "Landing(gRPC)" "${LANDING_SERVER_GRPC_PORT}"
    kill_if_exists "Chat"         "${CHAT_SERVER_HTTP_PORT}"
    kill_if_exists "Chat(gRPC)"   "${CHAT_SERVER_GRPC_PORT}"
    kill_if_exists "Notification" "${NOTIFICATION_SERVER_HTTP_PORT}"
    kill_if_exists "Notif(gRPC)"  "${NOTIFICATION_SERVER_GRPC_PORT}"
    pkill -f "envoy.*gateway" && echo "   üßπ Cleaned stray Envoy process" || true
    echo "‚úÖ Ports Check & Cleanup Done"

kill-all: kill-ports
    @echo "üíÄ Ensuring all processes are stopped..."
    @pkill -f "go run.*(landing|chat|notification|shell)" || true
    @echo "‚úÖ All services stopped"

restart: kill-all
    @sleep 1
    @just dev-all

# Observability Helpers
up-obs:
    cd deployments && docker-compose -f compose-observability.yaml up -d

down-obs:
    cd deployments && docker-compose -f compose-observability.yaml down

logs-obs:
    cd deployments && docker-compose -f compose-observability.yaml logs -f

logs-local-all:
    @echo "üìã Tailing all local service logs..."
    @tail -f /tmp/*.log 2>/dev/null || echo "No logs yet."

watch service:
    cd services/{{service}}/backend && find . -name "*.go" | entr -r go run cmd/server/main.go

config-dev:
    @cat configs/dev.env

info:
    @just check-status

# –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è –Ω–∞ –ª–æ–∫–∞–ª—å–Ω—É—é —Ä–∞–∑—Ä–∞–±–æ—Ç–∫—É
local:
    cp configs/local.env .env
    @echo "‚úÖ Switched to LOCAL environment"

# –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è –Ω–∞ dev –æ–∫—Ä—É–∂–µ–Ω–∏–µ
dev:
    cp configs/dev.env .env
    @echo "‚úÖ Switched to DEV environment"

# –ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ–∫—É—â–µ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
env-status:
    @echo "Current environment variables:"
    @grep "^APP_ENV=" .env || echo "APP_ENV not set"
    @grep "^KAFKA_PORT=" .env || echo "KAFKA_PORT not set"
