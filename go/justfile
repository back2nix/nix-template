default:
    @just --list

# --- INSTALL & DEPS ---

deps: deps-shell deps-greeter

deps-shell:
    cd shell/frontend && yarn install
    cd shell/backend && go mod tidy && gomod2nix

deps-greeter:
    cd services/greeter/frontend && yarn install
    cd services/greeter/backend && go mod tidy && gomod2nix

# --- CODE GENERATION ---

gen-proto:
    cd services/greeter/backend && protoc --go_out=. --go_opt=paths=source_relative \
           --go-grpc_out=. --go-grpc_opt=paths=source_relative \
           proto/helloworld/helloworld.proto

# --- RUNNING (Development) ---

dev-all:
    @echo "üöÄ Starting all services..."
    @just kill-ports
    @just dev-gateway &
    @just dev-shell &
    @just dev-greeter &
    @wait

dev-gateway:
    @echo "üåê Starting Envoy Gateway on :8080..."
    @export GATEWAY_HTTP_PORT=8080 GREETER_HOST=localhost GREETER_PORT=8081 && \
    envsubst < services/gateway/envoy.tmpl.yaml > /tmp/envoy.yaml && \
    envoy -c /tmp/envoy.yaml --service-cluster gateway --service-node dev 2>&1 | tee -a /tmp/gateway.log

dev-shell:
    @echo "üñ•  Starting Shell (Host) on :9002..."
    cd shell/frontend && yarn build
    @echo "Shell frontend built, starting backend..."
    cd shell/backend && SHELL_HTTP_PORT=9002 SHELL_STATIC_DIR=../frontend/dist APP_ENV=dev go run cmd/server/main.go 2>&1 | tee -a /tmp/shell.log

dev-greeter:
    @echo "üëã Starting Greeter Service..."
    cd services/greeter/frontend && yarn build
    @echo "Greeter frontend built, starting backend..."
    cd services/greeter/backend && APP_ENV=dev go run cmd/server/main.go 2>&1 | tee -a /tmp/greeter.log

# --- BUILD (Nix) ---

build:
    nix build .#all

build-gateway:
    nix build .#gateway

build-shell:
    nix build .#shell

build-greeter:
    nix build .#greeter

# --- TESTING ---

test:
    @echo "üß™ Running tests..."
    cd services/greeter/backend && go test ./... || true
    nix flake check -L

# --- UTILITIES ---

kill-ports:
    @echo "üíÄ Killing processes on our ports..."
    @lsof -ti:8080 | xargs kill -9 2>/dev/null || true
    @lsof -ti:8081 | xargs kill -9 2>/dev/null || true
    @lsof -ti:9002 | xargs kill -9 2>/dev/null || true
    @lsof -ti:50051 | xargs kill -9 2>/dev/null || true
    @echo "‚úÖ Ports cleared"

kill-all: kill-ports
    @echo "üíÄ Killing all service processes..."
    @pkill -f "envoy.*gateway" || true
    @pkill -f "go run.*greeter" || true
    @pkill -f "go run.*shell" || true
    @echo "‚úÖ All services stopped"

restart: kill-all
    @sleep 1
    @just dev-all

up-obs:
    @echo "üî≠ Starting Observability Stack (VM, Loki, Promtail, Tempo, Grafana)..."
    cd deployments && docker-compose -f compose-observability.yaml up -d
    @echo "üìä Grafana: http://localhost:3001"
    @echo "üìä Loki: http://localhost:3100"
    @echo "üìä VictoriaMetrics: http://localhost:8428"

down-obs:
    cd deployments && docker-compose -f compose-observability.yaml down

logs-obs:
    @echo "üìã Observability stack logs:"
    cd deployments && docker-compose -f compose-observability.yaml logs -f

# --- LOKI QUERIES (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –¥–ª—è GNU date) ---

logs-all:
    @echo "üìã All logs from Loki (last 1 hour):"
    @curl -G -s "http://localhost:3100/loki/api/v1/query_range" \
        --data-urlencode 'query={job=~".+"}' \
        --data-urlencode "start=$(date -u -d '1 hour ago' +%s)000000000" \
        --data-urlencode "end=$(date -u +%s)000000000" | jq -r '.data.result[]?.values[]?[1]' 2>/dev/null || echo "No logs found"

logs-greeter:
    @echo "üìã Greeter service logs (last 1 hour):"
    @curl -G -s "http://localhost:3100/loki/api/v1/query_range" \
        --data-urlencode 'query={service="greeter-service"}' \
        --data-urlencode "start=$(date -u -d '1 hour ago' +%s)000000000" \
        --data-urlencode "end=$(date -u +%s)000000000" | jq -r '.data.result[]?.values[]?[1]' 2>/dev/null || echo "No logs found"

logs-gateway:
    @echo "üìã Gateway logs (last 1 hour):"
    @curl -G -s "http://localhost:3100/loki/api/v1/query_range" \
        --data-urlencode 'query={container=~".*envoy.*|.*gateway.*"}' \
        --data-urlencode "start=$(date -u -d '1 hour ago' +%s)000000000" \
        --data-urlencode "end=$(date -u +%s)000000000" | jq -r '.data.result[]?.values[]?[1]' 2>/dev/null || echo "No logs found"

logs-errors:
    @echo "üìã All ERROR logs (last 1 hour):"
    @curl -G -s "http://localhost:3100/loki/api/v1/query_range" \
        --data-urlencode 'query={job=~".+"} |~ "(?i)error"' \
        --data-urlencode "start=$(date -u -d '1 hour ago' +%s)000000000" \
        --data-urlencode "end=$(date -u +%s)000000000" | jq -r '.data.result[]?.values[]?[1]' 2>/dev/null || echo "No logs found"

# --- LOCAL FILE LOGS ---

logs-gateway-local:
    @tail -f /tmp/gateway.log 2>/dev/null || echo "No gateway logs yet. Start with: just dev-gateway"

logs-greeter-local:
    @tail -f /tmp/greeter.log 2>/dev/null || echo "No greeter logs yet. Start with: just dev-greeter"

logs-shell-local:
    @tail -f /tmp/shell.log 2>/dev/null || echo "No shell logs yet. Start with: just dev-shell"

logs-local-all:
    @echo "üìã Tailing all local service logs..."
    @tail -f /tmp/*.log 2>/dev/null || echo "No logs yet. Start services with: just dev-all"

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ Promtail —Å–æ–±–∏—Ä–∞–µ—Ç –ª–æ–≥–∏
logs-promtail:
    @echo "üìã Promtail logs:"
    @docker logs deployments-promtail-1 2>&1 | tail -50

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å Loki
loki-status:
    @echo "üìã Loki status:"
    @curl -s http://localhost:3100/ready && echo "‚úÖ Loki is ready" || echo "‚ùå Loki is not ready"
    @echo ""
    @echo "üìã Loki labels:"
    @curl -s http://localhost:3100/loki/api/v1/labels | jq

# --- DEVELOPMENT HELPERS ---

watch-gateway:
    cd services/gateway/backend && find . -name "*.go" | entr -r go run cmd/server/main.go

watch-greeter:
    cd services/greeter/backend && find . -name "*.go" | entr -r go run cmd/server/main.go

# --- CONFIG MANAGEMENT ---

config-dev:
    @echo "üìã Dev config:"
    @cat configs/dev.env

config-staging:
    @echo "üìã Staging config:"
    @cat configs/staging.env

config-prod:
    @echo "üìã Production config:"
    @cat configs/prod.env

config-init:
    @echo "üìã Copying local.env.example to local.env..."
    @cp configs/local.env.example configs/local.env
    @echo "‚úÖ Edit configs/local.env for your local setup"

# --- INFO ---

info:
    @echo "üì¶ Project Structure:"
    @echo ""
    @echo "Services:"
    @echo "  - Gateway:   :8080 (HTTP)"
    @echo "  - Shell:     :9002 (HTTP)"
    @echo "  - Greeter:   :8081 (HTTP), :50051 (gRPC)"
    @echo ""
    @echo "Observability:"
    @echo "  - Grafana:         http://localhost:3001"
    @echo "  - Loki:            http://localhost:3100"
    @echo "  - VictoriaMetrics: http://localhost:8428"
    @echo "  - Tempo:           http://localhost:3200"
    @echo ""
    @echo "Endpoints:"
    @echo "  - http://localhost:8080/health         (Gateway health)"
    @echo "  - http://localhost:8080/api/greeter/*  (Proxy to Greeter)"
    @echo "  - http://localhost:8081/api/hello      (Greeter REST)"
    @echo "  - http://localhost:8081/health         (Greeter health)"
    @echo "  - http://localhost:9002                (Shell/Host)"
    @echo ""
    @echo "Local Logs:"
    @echo "  - /tmp/gateway.log   (Gateway stdout)"
    @echo "  - /tmp/greeter.log   (Greeter stdout)"
    @echo "  - /tmp/shell.log     (Shell stdout)"
    @echo ""
    @echo "Log Commands:"
    @echo "  just logs-local-all    - Tail all local logs"
    @echo "  just logs-greeter      - Query Loki for greeter logs"
    @echo "  just logs-gateway      - Query Loki for gateway logs"
    @echo "  just logs-promtail     - Check Promtail status"
    @echo "  just loki-status       - Check Loki status"

# --- QUICK START ---

setup: deps gen-proto config-init
    @echo "‚úÖ Project setup complete!"
    @just info

start: dev-all

check:
  nix flake check -L
