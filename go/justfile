default:
    @just --list

# --- INSTALL & DEPS ---

deps: deps-shell deps-greeter

# deps-gateway —É–¥–∞–ª–µ–Ω, —Ç–∞–∫ –∫–∞–∫ Go –º–æ–¥—É–ª–∏ —Ç–∞–º –±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–Ω—ã
deps-shell:
    cd shell/frontend && yarn install
    cd shell/backend && go mod tidy && gomod2nix

deps-greeter:
    cd services/greeter/frontend && yarn install
    cd services/greeter/backend && go mod tidy && gomod2nix

# --- CODE GENERATION ---

gen-proto:
    cd services/greeter/backend && protoc --go_out=. --go_opt=paths=source_relative \
           --go-grpc_out=. --go-grpc_opt=paths=source_relative \
           proto/helloworld/helloworld.proto

# --- RUNNING (Development) ---

dev-all:
    @echo "üöÄ Starting all services..."
    @just kill-ports
    @just dev-gateway &
    @just dev-shell &
    @just dev-greeter &
    @wait

dev-gateway:
    @echo "üåê Starting Envoy Gateway on :8080..."
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º envsubst –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–Ω—Ñ–∏–≥–∞ –∏ –∑–∞–ø—É—Å–∫–∞–µ–º envoy
    @export GATEWAY_HTTP_PORT=8080 GREETER_HOST=localhost GREETER_PORT=8081 && \
    envsubst < services/gateway/envoy.tmpl.yaml > /tmp/envoy.yaml && \
    envoy -c /tmp/envoy.yaml --service-cluster gateway --service-node dev

dev-shell:
    @echo "üñ•  Starting Shell (Host) on :9002..."
    cd shell/frontend && yarn build
    @echo "Shell frontend built, starting backend..."
    cd shell/backend && SHELL_HTTP_PORT=9002 SHELL_STATIC_DIR=../frontend/dist APP_ENV=dev go run cmd/server/main.go

dev-greeter:
    @echo "üëã Starting Greeter Service..."
    cd services/greeter/frontend && yarn build
    @echo "Greeter frontend built, starting backend..."
    cd services/greeter/backend && APP_ENV=dev go run cmd/server/main.go

# --- BUILD (Nix) ---

build:
    nix build .#all

build-gateway:
    nix build .#gateway

build-shell:
    nix build .#shell

build-greeter:
    nix build .#greeter

# --- TESTING ---

test:
    @echo "üß™ Running tests..."
    # Gateway —Ç–µ—Å—Ç–æ–≤ Go –±–æ–ª—å—à–µ –Ω–µ—Ç
    cd services/greeter/backend && go test ./... || true
    nix flake check -L

# --- UTILITIES ---

kill-ports:
    @echo "üíÄ Killing processes on our ports..."
    @lsof -ti:8080 | xargs kill -9 2>/dev/null || true
    @lsof -ti:8081 | xargs kill -9 2>/dev/null || true
    @lsof -ti:9002 | xargs kill -9 2>/dev/null || true
    @lsof -ti:50051 | xargs kill -9 2>/dev/null || true
    @echo "‚úÖ Ports cleared"

kill-all: kill-ports
    @echo "üíÄ Killing all service processes..."
    @pkill -f "envoy.*gateway" || true
    @pkill -f "go run.*greeter" || true
    @pkill -f "go run.*shell" || true
    @echo "‚úÖ All services stopped"

restart: kill-all
    @sleep 1
    @just dev-all

up-obs:
    @echo "üî≠ Starting Observability Stack (VM, Loki, Tempo, Grafana)..."
    cd deployments && docker-compose -f compose-observability.yaml up -d
    @echo "üìä Grafana: http://localhost:3001"

down-obs:
    cd deployments && docker-compose -f compose-observability.yaml down

# --- DEVELOPMENT HELPERS ---

watch-gateway:
    cd services/gateway/backend && find . -name "*.go" | entr -r go run cmd/server/main.go

watch-greeter:
    cd services/greeter/backend && find . -name "*.go" | entr -r go run cmd/server/main.go

logs-gateway:
    tail -f /tmp/gateway.log || echo "No gateway logs"

logs-greeter:
    tail -f /tmp/greeter.log || echo "No greeter logs"

# --- CONFIG MANAGEMENT ---

config-dev:
    @echo "üìã Dev config:"
    @cat configs/dev.env

config-staging:
    @echo "üìã Staging config:"
    @cat configs/staging.env

config-prod:
    @echo "üìã Production config:"
    @cat configs/prod.env

config-init:
    @echo "üìã Copying local.env.example to local.env..."
    @cp configs/local.env.example configs/local.env
    @echo "‚úÖ Edit configs/local.env for your local setup"

# --- INFO ---

info:
    @echo "üì¶ Project Structure:"
    @echo ""
    @echo "Services:"
    @echo "  - Gateway:   :8080 (HTTP)"
    @echo "  - Shell:     :9002 (HTTP)"
    @echo "  - Greeter:   :8081 (HTTP), :50051 (gRPC)"
    @echo ""
    @echo "Endpoints:"
    @echo "  - http://localhost:8080/health         (Gateway health)"
    @echo "  - http://localhost:8080/api/greeter/*  (Proxy to Greeter)"
    @echo "  - http://localhost:8081/api/hello      (Greeter REST)"
    @echo "  - http://localhost:8081/health         (Greeter health)"
    @echo "  - http://localhost:9002                (Shell/Host)"
    @echo ""
    @echo "Environments:"
    @echo "  - dev      (configs/dev.env)"
    @echo "  - staging  (configs/staging.env)"
    @echo "  - prod     (configs/prod.env)"
    @echo "  - local    (configs/local.env - create with 'just config-init')"
    @echo ""
    @echo "Commands:"
    @echo "  just deps          - Install all dependencies"
    @echo "  just dev-all       - Start all services (dev mode)"
    @echo "  just dev-staging   - Start in staging mode"
    @echo "  just test          - Run all tests"
    @echo "  just grpc-test     - Test gRPC endpoint"
    @echo "  just build         - Build with Nix"
    @echo "  just clean         - Clean artifacts"
    @echo "  just config-init   - Create local.env from example"

# --- QUICK START ---

setup: deps gen-proto config-init
    @echo "‚úÖ Project setup complete!"
    @just info

start: dev-all


check:
  nix flake check -L

